<html>

<head>
  <title>Scott's Design Challenge Page</title>
  <link rel="stylesheet" href="bower_components/PACE/themes/black/pace-theme-center-radar.css" />
  <link rel='stylesheet' href="bower_components/cartodb.js/themes/css/cartodb.css"/>
</head>
<style>
  html, body{
    height: 100%;
    width: 100%;
    overflow: hidden;
    margin:0px;
    padding:0px;
  }

  #map{
    height: 100%;
    width: 100%;
    overflow: hidden;
    margin:0px;
    padding: 0px;
  }
</style>
<body>


  <div id='map'>

  </div>

  <script src="bower_components/jquery/dist/jquery.min.js"></script>
  <script src="bower_components/PACE/pace.js"></script>
  <script src="bower_components/cartodb.js/cartodb.js"></script>
  <script src='bower_components/d3/d3.min.js'></script>
  <script src='//api.tiles.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.3.1/leaflet-omnivore.min.js'></script>
  <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>

  <script>
  var f = "./centroids.json";
  var chronMins = [5]
  var isochronHost = "http://matrix.mapzen.com/isochrone?"
  var mapzen_key = "mapzen-RsgxFds";
  var isoTime = 5;
  var isochronLayer;
  var parcelCentroids;
  var parcelGeojson;
  var isochroneOptions = {
    locations: [{
      lat:0,
      lon: 0
    }],
    costing: 'pedestrian',
    contours: [
      {
       time: 5,
      color: 'red'}
    ]
  }

  var id = "walk_time_5mins"

  var geojsonMarkerOptions = {
    radius: 8,
    fillColor: "#ff7800",
    color: "#000",
    weight: 1,
    opacity: 1,
    fillOpacity: 0.8
};

//map setup
map = L.map('map').setView([43.0731, -89.4012], 12);

L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map);

//empty on init

  $(document).ready(function(){
      initialize()
  })


  function initialize(){

    isochronLayer = L.geoJson().addTo(map);
    parcelCentroids = L.geoJson(null, {
      pointToLayer: function (feature, latlng) {
          return L.circleMarker(latlng, geojsonMarkerOptions);
      },
      onEachFeature: function(feature, layer){
        layer.on('click', function(e){
          coords = feature.geometry.coordinates
          console.log(coords);
          var lat = coords[1];
          var lng = coords[0];
          var time = isoTime;
          var callback = onIsoChronReceipt;
          getIsoChronFromPos(lat, lng, time, callback);
        })
      }
    }).addTo(map);

    $.getJSON(f, function(data){
      parcelCentroids.clearLayers();
      parcelCentroids.addData(data);
      parcelGeojson = data;
    })


    function getIsoChronFromPos(lat, lng, time, callback){
        requestOptions = isochroneOptions;
        requestOptions.locations[0].lat = lat;
        requestOptions.locations[0].lon = lng;
        requestOptions.contours[0].time = time

        requestOptions = JSON.stringify(requestOptions);

        var requestEndpoint = isochronHost + "json=" + requestOptions + "&id=walk_time_5mins&api_key=" + mapzen_key + "&polygons=true"


        $.getJSON(requestEndpoint, function(data){
          callback(data)
        })
    }

    function onIsoChronReceipt(isoGeojson){
      displayIsoLines(isoGeojson);
      calcWithinIsoLines(isoGeojson, parcelGeojson);
    }

    function displayIsoLines(isoGeojson){
      isochronLayer.clearLayers();
      isochronLayer.addData(isoGeojson);
    }

    function calcWithinIsoLines(isoGeojson, points){
      var pointsWithin = turf.within(points, isoGeojson);
      return pointsWithin;
    }




}//end init



  </script>
</body>
</html>
